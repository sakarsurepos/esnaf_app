import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import supabase from '../services/supabase';
import { User, Session, AuthChangeEvent } from '@supabase/supabase-js';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { sampleUsers } from '../models';

// Mock veri modu kontrolÃ¼
const USE_MOCK_DATA = process.env.USE_MOCK_DATA === 'true';
const IS_DEV = process.env.NODE_ENV === 'development';

// Mock kullanÄ±cÄ± ve oturum oluÅŸturmak iÃ§in yardÄ±mcÄ± fonksiyonlar
const createMockUser = (userData: any): User => {
  return {
    id: userData.id,
    email: userData.email,
    user_metadata: {
      first_name: userData.first_name,
      last_name: userData.last_name,
      bio: userData.bio,
      phone: userData.phone,
      profile_image: userData.profile_image,
    },
    app_metadata: {},
    aud: 'authenticated',
    created_at: userData.created_at || new Date().toISOString(),
  } as User;
};

const createMockSession = (user: User): Session => {
  return {
    access_token: 'mock-access-token',
    refresh_token: 'mock-refresh-token',
    expires_in: 3600,
    expires_at: Math.floor(Date.now() / 1000) + 3600,
    token_type: 'bearer',
    user: user,
  } as Session;
};

interface AuthContextType {
  user: User | null;
  session: Session | null;
  isLoading: boolean;
  error: Error | null;
  login: (email: string, password: string) => Promise<{ error: Error | null }>;
  register: (email: string, password: string) => Promise<{ error: Error | null }>;
  logout: () => Promise<void>;
  resetPassword: (email: string) => Promise<{ error: Error | null }>;
  updateProfile: (data: any) => Promise<{ error: Error | null }>;
}

const AuthContext = createContext<AuthContextType | null>(null);

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

interface AuthProviderProps {
  children: ReactNode;
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [error, setError] = useState<Error | null>(null);

  useEffect(() => {
    if (IS_DEV && USE_MOCK_DATA) {
      console.log('ðŸ§ª Mock kimlik doÄŸrulama modunda Ã§alÄ±ÅŸÄ±lÄ±yor');
      initMockAuth();
    } else {
      console.log('ðŸ”Œ GerÃ§ek Supabase kimlik doÄŸrulama kullanÄ±lÄ±yor');
      initRealAuth();
    }
  }, []);

  // Mock kimlik doÄŸrulama baÅŸlatma
  const initMockAuth = async () => {
    try {
      // AsyncStorage'dan mevcut oturum kontrolÃ¼
      const storedSession = await AsyncStorage.getItem('mock_session');
      
      if (storedSession) {
        const sessionData = JSON.parse(storedSession) as Session;
        setSession(sessionData);
        setUser(sessionData.user);
      } else {
        // Demo amacÄ±yla otomatik giriÅŸ yapÄ±labilir (istenirse)
        // VarsayÄ±lan olarak oturumu kapalÄ± baÅŸlatÄ±yoruz
        setUser(null);
        setSession(null);
      }
    } catch (error) {
      console.error('Mock oturum kontrolÃ¼nde hata:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // GerÃ§ek Supabase kimlik doÄŸrulamayÄ± baÅŸlatma
  const initRealAuth = () => {
    // Mevcut oturumu kontrol et
    checkSession();

    // Auth state'i dinle
    const { data: authListener } = supabase.auth.onAuthStateChange(
      async (event: AuthChangeEvent, session: Session | null) => {
        console.log(`Supabase auth event: ${event}`);
        setSession(session);
        setUser(session?.user ?? null);
        setIsLoading(false);

        // Oturum bilgilerini AsyncStorage'a kaydet
        if (session) {
          await AsyncStorage.setItem('session', JSON.stringify(session));
        } else {
          await AsyncStorage.removeItem('session');
        }
      }
    );

    return () => {
      // Dinleyiciyi kaldÄ±r
      if (authListener && authListener.subscription) {
        authListener.subscription.unsubscribe();
      }
    };
  };

  const checkSession = async () => {
    try {
      setIsLoading(true);

      // Yerel depodan oturum bilgilerini alma denemesi
      const storedSession = await AsyncStorage.getItem('session');
      
      if (storedSession) {
        const sessionData = JSON.parse(storedSession) as Session;
        setSession(sessionData);
        setUser(sessionData.user);
      }

      // Supabase oturum kontrolÃ¼
      const { data, error } = await supabase.auth.getSession();
      
      if (error) {
        throw error;
      }

      setSession(data.session);
      setUser(data.session?.user ?? null);
    } catch (error) {
      console.error('Oturum kontrolÃ¼nde hata:', error);
      setError(error as Error);
    } finally {
      setIsLoading(false);
    }
  };

  const login = async (email: string, password: string) => {
    try {
      setIsLoading(true);
      setError(null);
      
      if (IS_DEV && USE_MOCK_DATA) {
        // Mock giriÅŸ iÅŸlemi - KullanÄ±cÄ±yÄ± Ã¶rnek verilerden bul
        const foundUser = sampleUsers.find(user => 
          user.email.toLowerCase() === email.toLowerCase() && 
          // GerÃ§ekte ÅŸifre hash'leri karÅŸÄ±laÅŸtÄ±rÄ±lÄ±r, ancak demo amaÃ§lÄ± doÄŸrudan ÅŸifreleri kontrol ediyoruz
          // Not: Bu sadece mock data iÃ§in gÃ¼venli bir yaklaÅŸÄ±mdÄ±r, gerÃ§ek uygulamada asla yapÄ±lmamalÄ±dÄ±r
          user.password_hash === password
        );
        
        if (foundUser) {
          const mockUser = createMockUser(foundUser);
          const mockSession = createMockSession(mockUser);
          
          setUser(mockUser);
          setSession(mockSession);
          
          // Mock oturum bilgilerini AsyncStorage'a kaydet
          await AsyncStorage.setItem('mock_session', JSON.stringify(mockSession));
          
          return { error: null };
        } else {
          throw new Error('GeÃ§ersiz e-posta veya ÅŸifre');
        }
      } else {
        // GerÃ§ek Supabase giriÅŸ iÅŸlemi
        const { error } = await supabase.auth.signInWithPassword({
          email,
          password,
        });

        if (error) throw error;
        
        return { error: null };
      }
    } catch (error) {
      console.error('GiriÅŸ hatasÄ±:', error);
      setError(error as Error);
      return { error: error as Error };
    } finally {
      setIsLoading(false);
    }
  };

  const register = async (email: string, password: string) => {
    try {
      setIsLoading(true);
      setError(null);
      
      if (IS_DEV && USE_MOCK_DATA) {
        // Mock kayÄ±t iÅŸlemi
        if (email && password && password.length >= 6) {
          // Ã–nce e-posta adresinin kullanÄ±lmadÄ±ÄŸÄ±ndan emin olalÄ±m
          const existingUser = sampleUsers.find(user => 
            user.email.toLowerCase() === email.toLowerCase()
          );
          
          if (existingUser) {
            throw new Error('Bu e-posta adresi zaten kullanÄ±lÄ±yor');
          }
          
          // Yeni bir kullanÄ±cÄ± oluÅŸtur (Ã¶rnek kullanÄ±cÄ±yÄ± temel alarak)
          const templateUser = sampleUsers[0];
          const newUser = {
            ...templateUser,
            id: `mock-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
            email: email,
            password_hash: password, // gerÃ§ek uygulamada asla bÃ¶yle yapÄ±lmamalÄ±
            first_name: '',
            last_name: '',
            created_at: new Date().toISOString()
          };
          
          const mockUser = createMockUser(newUser);
          const mockSession = createMockSession(mockUser);
          
          setUser(mockUser);
          setSession(mockSession);
          
          // Mock oturum bilgilerini AsyncStorage'a kaydet
          await AsyncStorage.setItem('mock_session', JSON.stringify(mockSession));
          
          return { error: null };
        } else {
          throw new Error('GeÃ§ersiz e-posta veya ÅŸifre');
        }
      } else {
        // GerÃ§ek Supabase kayÄ±t iÅŸlemi
        const { error } = await supabase.auth.signUp({
          email,
          password,
        });

        if (error) throw error;
        
        return { error: null };
      }
    } catch (error) {
      console.error('KayÄ±t hatasÄ±:', error);
      setError(error as Error);
      return { error: error as Error };
    } finally {
      setIsLoading(false);
    }
  };

  const logout = async () => {
    try {
      setIsLoading(true);
      setError(null);
      
      if (IS_DEV && USE_MOCK_DATA) {
        // Mock Ã§Ä±kÄ±ÅŸ iÅŸlemi
        setUser(null);
        setSession(null);
        await AsyncStorage.removeItem('mock_session');
      } else {
        // GerÃ§ek Supabase Ã§Ä±kÄ±ÅŸ iÅŸlemi
        const { error } = await supabase.auth.signOut();
        
        if (error) throw error;
        
        setUser(null);
        setSession(null);
        await AsyncStorage.removeItem('session');
      }
    } catch (error) {
      console.error('Ã‡Ä±kÄ±ÅŸ hatasÄ±:', error);
      setError(error as Error);
    } finally {
      setIsLoading(false);
    }
  };

  const resetPassword = async (email: string) => {
    try {
      setIsLoading(true);
      setError(null);
      
      if (IS_DEV && USE_MOCK_DATA) {
        // Mock ÅŸifre sÄ±fÄ±rlama
        console.log(`Mock ÅŸifre sÄ±fÄ±rlama e-postasÄ± gÃ¶nderildi: ${email}`);
        return { error: null };
      } else {
        // GerÃ§ek Supabase ÅŸifre sÄ±fÄ±rlama
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: 'esnafmusterim://reset-password',
        });
        
        if (error) throw error;
        
        return { error: null };
      }
    } catch (error) {
      console.error('Åžifre sÄ±fÄ±rlama hatasÄ±:', error);
      setError(error as Error);
      return { error: error as Error };
    } finally {
      setIsLoading(false);
    }
  };

  const updateProfile = async (data: any) => {
    try {
      setIsLoading(true);
      setError(null);
      
      if (IS_DEV && USE_MOCK_DATA) {
        // Mock profil gÃ¼ncelleme
        if (user) {
          const updatedUser = {
            ...user,
            user_metadata: {
              ...user.user_metadata,
              ...data.data
            }
          };
          
          setUser(updatedUser);
          
          // Oturum bilgilerini gÃ¼ncelle
          if (session) {
            const updatedSession = {
              ...session,
              user: updatedUser
            };
            
            setSession(updatedSession);
            await AsyncStorage.setItem('mock_session', JSON.stringify(updatedSession));
          }
        }
        
        return { error: null };
      } else {
        // GerÃ§ek Supabase profil gÃ¼ncelleme
        const { error } = await supabase.auth.updateUser(data);
        
        if (error) throw error;
        
        // Profil gÃ¼ncellendikten sonra kullanÄ±cÄ± bilgilerini gÃ¼ncelle
        const { data: userData, error: sessionError } = await supabase.auth.getUser();
        
        if (sessionError) throw sessionError;
        if (userData) setUser(userData.user);
        
        return { error: null };
      }
    } catch (error) {
      console.error('Profil gÃ¼ncelleme hatasÄ±:', error);
      setError(error as Error);
      return { error: error as Error };
    } finally {
      setIsLoading(false);
    }
  };

  const value = {
    user,
    session,
    isLoading,
    error,
    login,
    register,
    logout,
    resetPassword,
    updateProfile,
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
}; 